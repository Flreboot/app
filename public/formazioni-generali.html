<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FFL Reboot — Formazioni Generali</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    .card { max-width: 1200px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .topbar-left { display:flex; align-items:center; gap:10px; }
    .topbar-left .logo { height:44px; display:block; }
    .topbar-right{ display:flex; align-items:center; gap:8px; }
    .title { font-weight:800; letter-spacing:.5px; }
    .grid {
      display:grid;
      grid-template-columns: repeat(4, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 8px;
    }
    @media (max-width: 1100px) {
      .grid { grid-template-columns: repeat(3, minmax(240px, 1fr)); }
    }
    @media (max-width: 840px) {
      .grid { grid-template-columns: repeat(2, minmax(240px, 1fr)); }
    }
    @media (max-width: 560px) {
      .grid { grid-template-columns: 1fr; }
    }
    .team-card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)), var(--card);
      border:1px solid rgba(47,116,255,.25);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .team-head{
      display:flex; align-items:baseline; justify-content:space-between; gap:8px;
    }
    .team-name{ font-weight:800; text-transform:uppercase; letter-spacing:.5px; font-size:1.1rem; }
    .modulo{ color: var(--muted); font-size:.95rem; }
    .cols{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .list{
      margin:0; padding-left: 18px;
    }
    .list li{ margin: 2px 0; }
    .label{ font-size:.9rem; color: var(--muted); margin-top:4px; }
    .kv{ display:flex; gap:6px; flex-wrap:wrap; font-size:.95rem; }
    .kv strong{ font-weight:700; }
    .saved{ margin-top:4px; font-size:.85rem; color:var(--muted); }
    .refresh-btn {
      padding: 6px 10px;
      font-size: 0.8rem;
      border: none;
      border-radius: 8px;
      background: linear-gradient(180deg, #ffa24d, #ff7a00);
      color: #0b0f19;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: .4px;
      transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
      box-shadow: 0 2px 6px rgba(255,122,0,.25);
    }
    .refresh-btn:hover { filter: brightness(1.05); }
    .refresh-btn:active { transform: translateY(1px); }
    .back-btn {
      padding: 8px 14px;
      font-size: 0.85rem;
      border: none;
      border-radius: 8px;
      background: linear-gradient(180deg, #c1121f, #a00);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: .4px;
      box-shadow: 0 2px 6px rgba(193,18,31,.35);
      transition: transform .08s ease, filter .15s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .back-btn:hover { filter: brightness(1.1); }
    .back-btn:active { transform: translateY(1px); }
  </style>
</head>
<body>
  <main class="container">
    <section class="card">
      <header class="topbar">
        <div class="topbar-left">
          <img src="/img/logo.png" alt="FFL Reboot Logo" class="logo" />
          <h1 class="title">Formazioni Generali</h1>
        </div>
        <div class="topbar-right">
          <a href="/dashboard" class="back-btn" id="backBtn" role="button">Indietro</a>
          <button class="refresh-btn" id="refreshBtn" type="button">Aggiorna</button>
        </div>
      </header>

      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </main>

  <script>
    function pad(n){ return String(n).padStart(2,'0'); }
    function fmt(dtstr){
      if(!dtstr) return '—';
      const d = new Date(dtstr);
      if(Number.isNaN(d.getTime())) return '—';
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    async function ensureLogged(){
      try {
        const me = await fetch('/api/me', {cache:'no-store'}).then(r=>r.json());
        if(!me.ok){ location.href = '/login.html'; return false; }
        return true;
      } catch(e){
        location.href = '/login.html';
        return false;
      }
    }

    function makeList(items, startAt){
      const ol = document.createElement('ol');
      ol.className = 'list';
      if(startAt) ol.start = startAt;
      for(const it of items){
        const li = document.createElement('li');
        li.textContent = it || '';
        ol.appendChild(li);
      }
      return ol;
    }

    function teamCard(obj){
      const wrap = document.createElement('div');
      wrap.className = 'team-card';

      const head = document.createElement('div');
      head.className = 'team-head';
      const nameEl = document.createElement('div');
      nameEl.className = 'team-name';
      nameEl.textContent = (obj.username || '').toUpperCase();
      const modulo = document.createElement('div');
      modulo.className = 'modulo';
      modulo.textContent = obj.modulo ? `Modulo: ${obj.modulo}` : 'Modulo: —';
      head.appendChild(nameEl);
      head.appendChild(modulo);

      const cols = document.createElement('div');
      cols.className = 'cols';

      const titolari = [];
      const riserve = [];
      for(let i=1;i<=11;i++) titolari.push(obj.slots?.[String(i)] || '');
      for(let i=12;i<=23;i++) riserve.push(obj.slots?.[String(i)] || '');

      const colA = document.createElement('div');
      const labA = document.createElement('div'); labA.className = 'label'; labA.textContent = 'Titolari';
      colA.appendChild(labA);
      colA.appendChild(makeList(titolari, 1));

      const colB = document.createElement('div');
      const labB = document.createElement('div'); labB.className = 'label'; labB.textContent = 'Riserve';
      colB.appendChild(labB);
      colB.appendChild(makeList(riserve, 12));

      cols.appendChild(colA);
      cols.appendChild(colB);

      const infos = document.createElement('div');
      infos.className = 'kv';
      const cap = document.createElement('div');
      cap.innerHTML = '<strong>Capitano:</strong> ' + (obj.capitano || '—');
      const vice = document.createElement('div');
      vice.innerHTML = '<strong>Vice:</strong> ' + (obj.vicecapitano || '—');
      infos.appendChild(cap);
      infos.appendChild(vice);

      const saved = document.createElement('div');
      saved.className = 'saved';
      saved.textContent = 'Inserita il: ' + fmt(obj.saved_at);

      wrap.appendChild(head);
      wrap.appendChild(cols);
      wrap.appendChild(infos);
      wrap.appendChild(saved);
      return wrap;
    }

    async function loadAll(){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      try {
        const resp = await fetch('/api/admin/aggregate-formazioni', {cache:'no-store'});
        const js = await resp.json();
        if(!js.ok){ grid.textContent = 'Nessuna formazione disponibile.'; return; }

        const data = Array.isArray(js.data) ? js.data : [];
        // Ordina alfabeticamente per username per coerenza
        data.sort((a,b)=> (a.username||'').localeCompare(b.username||''));

        if(data.length === 0){
          grid.textContent = 'Nessuna formazione disponibile.';
          return;
        }

        for(const obj of data){
          grid.appendChild(teamCard(obj));
        }
      } catch(e){
        grid.textContent = 'Errore nel recupero delle formazioni.';
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadAll);

    (async function init(){
      if(await ensureLogged()){
        loadAll();
      }
    })();
  </script>
</body>
</html>
